<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchPlan Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéæ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body class="text-gray-800">

    <!-- Mobile Header -->
    <div id="mobile-header" class="hidden">
        <h1 class="text-xl font-bold" style="color: #45658e;">MatchPlan Pro</h1>
        <button id="burger-menu-btn" aria-label="Men√º √∂ffnen">
            <i class="fa-solid fa-bars"></i>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav">
        <button id="mobile-nav-close-btn" aria-label="Men√º schlie√üen">&times;</button>
        <button id="mobile-sync-backup-btn" class="mobile-nav-link">
            <i class="fa-solid fa-rotate"></i> Synchronisation
        </button>
    </div>
    <div id="mobile-nav-overlay"></div>


    <div id="app" class="container mx-auto p-4 md:p-4" style="max-width: 82.4rem;">

        <main class="mt-0">
            <div id="phase-selector-container" class="mb-8 box rounded-xl grid grid-cols-1 lg:grid-cols-3 lg:gap-8 items-center p-4">
                <div class="lg:col-span-1 mb-4 lg:mb-0 flex items-center gap-3">
                     <i class="fa-solid fa-medal app-title-icon text-3xl"></i>
                     <h2 class="app-title text-4xl" style="color: #45658e;">MatchPlan Pro</h2>
                </div>
                <div class="lg:col-span-2 flex items-center gap-4">
                    <div id="phase-selector" class="flex-grow grid grid-cols-4 gap-2">
                        <button data-phase="1" class="phase-btn phase-button font-semibold py-2 px-4 rounded-xl text-sm"><span>1. Grundlagen</span></button>
                        <button data-phase="2" class="phase-btn phase-button font-semibold py-2 px-4 rounded-xl text-sm"><span>2. Pr√§zision</span></button>
                        <button data-phase="3" class="phase-btn phase-button font-semibold py-2 px-4 rounded-xl text-sm"><span>3. Matchpraxis</span></button>
                        <button data-phase="4" class="phase-btn phase-button font-semibold py-2 px-4 rounded-xl text-sm"><span>4. Turnierfokus</span></button>
                    </div>
                    <button id="sync-backup-btn" class="flex-shrink-0" aria-label="Daten importieren oder exportieren">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>

            <div id="content-area" class="gradient-bg p-6 rounded-2xl relative box">
                <div class="flex flex-col lg:flex-row gap-8">
                    
                    <div id="left-content-column" class="lg:w-1/3 flex flex-col justify-between">
                        <div>
                            <h3 class="text-2xl font-bold mb-3 text-gray-900">Ziele dieser Phase</h3>
                            <div id="phase-goals" class="prose text-sm"></div>
                            <textarea id="phase-goals-editor" class="hidden w-full text-sm p-2 border rounded-md bg-gray-50"></textarea>
                        </div>
                        <div class="bg-white/60 p-4 rounded-xl my-8">
                            <h3 class="text-lg font-bold mb-3 text-center text-gray-900">W√∂chentlicher Fokus</h3>
                            <div class="chart-container">
                                <canvas id="weeklyFocusChart"></canvas>
                                <div id="intensity-index" class="intensity-index"></div>
                            </div>
                            <div id="weeklyFocusLegend" class="flex justify-center flex-nowrap gap-x-3 mt-4 text-xs"></div>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold mb-3 text-gray-900">Wichtige Tipps</h3>
                            <div id="tips-container" class="space-y-4">
                            </div>
                        </div>
                    </div>

                    <div id="right-content-column" class="lg:w-2/3 flex flex-col">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-week-btn" class="py-1.5 px-3.5 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">‚Üê</button>
                                <div class="flex items-center flex-nowrap gap-2">
                                    <h3 id="current-week-display-wrapper" class="text-2xl font-bold text-gray-900 text-center cursor-pointer"><span id="current-week-display"></span></h3>
                                    <button id="add-week-btn" class="edit-mode-icon-btn hidden" aria-label="Neue Woche hinzuf√ºgen"><i class="fa-solid fa-plus"></i></button>
                                    <button id="delete-week-btn" class="edit-mode-icon-btn hidden" aria-label="Diese Woche l√∂schen"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                                <button id="next-week-btn" class="py-1.5 px-3.5 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">‚Üí</button>
                            </div>
                            <div class="relative">
                                <div id="weekly-plan" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                </div>
                                <button id="edit-mode-toggle-btn" class="absolute bottom-4 right-4" aria-label="Plan bearbeiten"></button>
                            </div>
                            
                            <div id="stats-section" class="mt-8 p-6 rounded-2xl box">
                                <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Dein Trainingsfortschritt</h2>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white rounded-xl">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase tracking-wider rounded-tl-xl">Kategorie</th>
                                                <th class="py-3 px-4 text-center text-sm font-semibold uppercase tracking-wider" style="color: #88bab8;">Durchgef√ºhrt</th>
                                                <th class="py-3 px-4 text-center text-sm font-semibold uppercase tracking-wider" style="color: #ec747c;">Verpasst</th>
                                                <th class="py-3 px-4 text-center text-sm font-semibold uppercase tracking-wider" style="color: #54749b;">Offen</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stats-table-body" class="divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="weight-section" class="mt-8 p-6 rounded-2xl box flex-grow flex flex-col">
                            <h2 class="text-2xl font-bold text-center mb-6 text-gray-900">Deine Gewichtsentwicklung</h2>
                            <div class="flex-grow" style="position: relative; min-height: 250px;">
                                <canvas id="weight-curve-chart" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>

                    </div>
                </div>
                 <footer id="version-footer" class="text-right text-xs mt-4" style="color: #45658e;"></footer>
            </div>
        </main>
    </div>

    <div id="exercise-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modal-title" class="text-2xl md:text-3xl font-bold"></h2>
                    <button id="modal-close-btn" class="modal-close-button text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modal-content" class="space-y-4 modal-content-area prose"></div>
            </div>
        </div>
    </div>

    <div id="add-training-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-md relative">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="add-modal-title" class="text-2xl md:text-3xl font-bold"></h2>
                    <button id="add-training-close-btn" class="modal-close-button text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div class="mb-4">
                    <button type="button" id="edit-categories-btn" class="w-full text-sm font-semibold py-2 px-4 rounded-lg transition-colors bg-gray-200 hover:bg-gray-300">
                        <i class="fa-solid fa-pencil-alt mr-2"></i> Intensit√§ts-Kategorien bearbeiten
                    </button>
                </div>
                <form id="add-training-form">
                    <div class="space-y-4">
                        <div>
                            <label for="add-training-day-select" class="block text-sm font-medium text-gray-700">Wochentag:</label>
                            <select id="add-training-day-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3"></select>
                        </div>
                        <div>
                            <label for="add-training-type-input" class="block text-sm font-medium text-gray-700">Trainingsart:</label>
                            <input type="text" id="add-training-type-input" list="training-types-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="z.B. Krafttraining" required>
                            <datalist id="training-types-list"></datalist>
                        </div>
                        <div>
                            <label for="add-training-icon-input" class="block text-sm font-medium text-gray-700">Icon (Emoji):</label>
                            <input type="text" id="add-training-icon-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-3" placeholder="z.B. üèãÔ∏è">
                        </div>
                        <div>
                            <label for="add-training-short-description-input" class="block text-sm font-medium text-gray-700">Kurzbeschreibung:</label>
                            <textarea id="add-training-short-description-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="3" placeholder="Wird auf der Wochenkarte angezeigt."></textarea>
                        </div>
                        <div>
                            <label for="add-training-description-input" class="block text-sm font-medium text-gray-700">Detailbeschreibung:</label>
                            <textarea id="add-training-description-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="6" placeholder="Wird im Detailfenster angezeigt. Markdown wird unterst√ºtzt."></textarea>
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="add-training-cancel-btn" class="modal-cancel-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Abbrechen</button>
                            <button type="submit" id="add-training-submit-btn" class="text-white font-bold py-2 px-4 rounded-lg transition-colors">Speichern</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-categories-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-lg relative max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl md:text-3xl font-bold">Intensit√§ts-Kategorien</h2>
                    <button id="edit-categories-close-btn" class="modal-close-button text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                 <p class="text-sm text-gray-600 mt-2">Hier k√∂nnen Sie die Intensit√§t f√ºr jede Trainingsart festlegen. Die √Ñnderung wirkt sich auf die Berechnung des Intensit√§tsindex aus.</p>
            </div>
            <div id="category-editor-content" class="p-6 overflow-y-auto">
            </div>
        </div>
    </div>

    <div id="sync-backup-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-md relative">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl md:text-3xl font-bold">Synchronisation</h2>
                    <button id="sync-backup-close-btn" class="modal-close-button text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                
                <!-- Online Sync Section -->
                <div id="online-sync-section" class="space-y-4">
                    <h3 class="text-lg font-semibold">Online-Synchronisation (Empfohlen)</h3>
                    <p class="text-sm text-gray-600">Teilen Sie diesen Link, um den Plan auf anderen Ger√§ten zu laden. √Ñnderungen werden nach dem Bearbeiten automatisch synchronisiert.</p>
                    <button id="create-share-link-btn" class="w-full font-bold py-2 px-4 rounded-lg transition-colors">
                        <i class="fa-solid fa-link mr-2"></i> Freigabe-Link erstellen/anzeigen
                    </button>
                    <div id="share-link-container" class="hidden space-y-2">
                        <label for="share-link-input" class="text-sm font-medium text-gray-700">Ihr pers√∂nlicher Sync-Link:</label>
                        <div class="flex gap-2">
                            <input type="text" id="share-link-input" readonly class="flex-grow bg-gray-100 border rounded-md p-2 text-sm">
                            <button id="copy-link-btn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md" aria-label="Link kopieren">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                             <button id="delete-online-data-btn" class="p-2 rounded-md text-red-500 hover:bg-red-100" aria-label="Online-Plan l√∂schen" style="color: var(--danger-color);">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-center gap-4 pt-2">
                        <button id="manual-sync-btn" class="text-sm font-semibold text-gray-700 hover:text-gray-900">Jetzt manuell synchronisieren</button>
                        <div id="sync-status-indicator" class="flex items-center gap-2 text-sm text-gray-500">
                            <i id="sync-status-icon" class="fa-solid fa-cloud"></i>
                            <span id="sync-status-text">Bereit</span>
                        </div>
                    </div>
                </div>

                <!-- Manual Backup Section -->
                <div class="border-t pt-6 mt-6 space-y-6">
                    <h3 class="text-lg font-semibold">Manuelles Backup (Offline)</h3>
                    <div>
                        <p class="text-sm text-gray-600 mb-2">Sichere deinen gesamten Fortschritt und deine personalisierten Pl√§ne in einer Datei.</p>
                        <button id="export-data-btn" class="w-full font-bold py-2 px-4 rounded-lg transition-colors">Backup-Datei herunterladen</button>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 mb-2">Stelle deine Daten aus einer Backup-Datei wieder her. Achtung: Alle aktuellen Daten werden √ºberschrieben!</p>
                        <label for="import-file-input" class="custom-file-upload text-center w-full block">
                            <i class="fa-solid fa-upload mr-2"></i> Backup-Datei ausw√§hlen
                        </label>
                        <input type="file" id="import-file-input" accept=".json">
                        <div id="import-feedback-area" class="mt-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="modal-box bg-white rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="p-6 text-center">
                <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Aktion best√§tigen</h2>
                <p id="confirm-modal-text" class="mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-modal-cancel-btn" class="modal-cancel-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors">Abbrechen</button>
                    <button id="confirm-modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Best√§tigen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);
        
        const HTML_VERSION = "2.3.3";
        const DATA_MODEL_VERSION = 5;
        const JSONBLOB_API_URL = "https://jsonblob.com/api/jsonBlob";

        // --- State Management ---
        let state = {
            planId: null,
            syncId: null,
            lastModified: null,
            currentWeekIndex: 0,
            isEditMode: false,
            startDateOfPlan: null,
            trainingProgress: {},
            trainingTypes: {}, 
            weeklySchedules: [], 
            phaseData: {} 
        };
        
        let dataChangedSinceLastSync = false;
        let categorySortState = { key: 'name', order: 'asc' };

        // --- Constants ---
        const DAYS_OF_WEEK = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
        let weeklyFocusChart;
        let weightCurveChart;

        const allTips = [
            { icon: 'üß†', title: 'Mentale St√§rke', text: 'Tennis ist Kopfsache. Bleib geduldig, analysiere Fehler konstruktiv und lass dich von R√ºckschl√§gen nicht entmutigen.' },
            { icon: 'üèÉ‚Äç‚ôÇÔ∏è', title: 'Konstanz schl√§gt Intensit√§t', text: 'Regelm√§√üiges, geplantes Training ist effektiver als unregelm√§√üige, √ºberintensive Einheiten. H√∂re auf deinen K√∂rper, um Verletzungen zu vermeiden.' },
            { icon: 'ü§ù', title: 'Trainingspartner', text: 'Suche dir nach den ersten Monaten Spielpartner. Regelm√§√üige Matches sind der beste Weg, um das Gelernte anzuwenden und Matchpraxis zu sammeln.' },
        ];

        // --- DOM Elements ---
        const DOMElements = {
            phaseSelector: document.getElementById('phase-selector'),
            phaseGoals: document.getElementById('phase-goals'),
            phaseGoalsEditor: document.getElementById('phase-goals-editor'),
            weeklyPlan: document.getElementById('weekly-plan'),
            currentWeekDisplay: document.getElementById('current-week-display'),
            currentWeekContainer: document.getElementById('current-week-display-wrapper'),
            prevWeekBtn: document.getElementById('prev-week-btn'),
            nextWeekBtn: document.getElementById('next-week-btn'),
            statsTableBody: document.getElementById('stats-table-body'),
            editModeToggleBtn: document.getElementById('edit-mode-toggle-btn'),
            syncBackupBtn: document.getElementById('sync-backup-btn'),
            addWeekBtn: document.getElementById('add-week-btn'),
            deleteWeekBtn: document.getElementById('delete-week-btn'),
            tipsContainer: document.getElementById('tips-container'),
            intensityIndex: document.getElementById('intensity-index'), 
            // Mobile Nav
            burgerMenuBtn: document.getElementById('burger-menu-btn'),
            mobileNav: document.getElementById('mobile-nav'),
            mobileNavCloseBtn: document.getElementById('mobile-nav-close-btn'),
            mobileSyncBackupBtn: document.getElementById('mobile-sync-backup-btn'),
            mobileNavOverlay: document.getElementById('mobile-nav-overlay'),
            // Modals
            exerciseModal: document.getElementById('exercise-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            addTrainingModal: document.getElementById('add-training-modal'),
            addModalTitle: document.getElementById('add-modal-title'),
            addTrainingForm: document.getElementById('add-training-form'),
            trainingTypesList: document.getElementById('training-types-list'),
            syncBackupModal: document.getElementById('sync-backup-modal'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalText: document.getElementById('confirm-modal-text'),
            confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
            versionFooter: document.getElementById('version-footer'),
            // Category Editor
            editCategoriesBtn: document.getElementById('edit-categories-btn'),
            editCategoriesModal: document.getElementById('edit-categories-modal'),
            categoryEditorContent: document.getElementById('category-editor-content'),
            // Sync & Backup Modal Elements
            createShareLinkBtn: document.getElementById('create-share-link-btn'),
            shareLinkContainer: document.getElementById('share-link-container'),
            shareLinkInput: document.getElementById('share-link-input'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            manualSyncBtn: document.getElementById('manual-sync-btn'),
            syncStatusIcon: document.getElementById('sync-status-icon'),
            syncStatusText: document.getElementById('sync-status-text'),
            deleteOnlineDataBtn: document.getElementById('delete-online-data-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            importFileInput: document.getElementById('import-file-input'),
            importFeedbackArea: document.getElementById('import-feedback-area'),
        };

        // --- Utility ---
        const parseDate = (dateString) => new Date(dateString);
        const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

        const parseMarkdown = (text) => {
            if (!text) return '';
            const lines = text.split('\n');
            let html = '';
            let listType = null;
            const processInline = (line) => line
                .replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>')
                .replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');

            for (const line of lines) {
                if (line.trim() === '') {
                    if (listType) {
                        html += `</${listType}>`;
                        listType = null;
                    }
                    continue;
                }

                if (line.startsWith('### ')) {
                    if (listType) { html += `</${listType}>`; listType = null; }
                    html += `<h3>${processInline(line.substring(4))}</h3>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    if (listType) { html += `</${listType}>`; listType = null; }
                    html += `<h2>${processInline(line.substring(3))}</h2>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    if (listType) { html += `</${listType}>`; listType = null; }
                    html += `<h1>${processInline(line.substring(2))}</h1>`;
                    continue;
                }
                
                const olMatch = line.match(/^\s*(\d+)\.\s+(.*)/);
                if (olMatch) {
                    if (listType !== 'ol') {
                        if (listType) html += `</${listType}>`;
                        html += '<ol>';
                        listType = 'ol';
                    }
                    html += `<li>${processInline(olMatch[2])}</li>`;
                    continue;
                }

                const ulMatch = line.match(/^\s*([*+-])\s+(.*)/);
                if (ulMatch) {
                    if (listType !== 'ul') {
                        if (listType) html += `</${listType}>`;
                        html += '<ul>';
                        listType = 'ul';
                    }
                    html += `<li>${processInline(ulMatch[2])}</li>`;
                    continue;
                }
                
                if (listType) {
                    html += `</${listType}>`;
                    listType = null;
                }
                html += `<p>${processInline(line)}</p>`;
            }
            if (listType) html += `</${listType}>`;
            return html;
        };


        const initializeDefaultData = () => {
            const defaultPhaseData = {
                1: { goals: "* Ziele f√ºr Phase 1 definieren..." },
                2: { goals: "* Ziele f√ºr Phase 2 definieren..." },
                3: { goals: "* Ziele f√ºr Phase 3 definieren..." },
                4: { goals: "* Ziele f√ºr Phase 4 definieren..." }
            };
            const defaultTrainingTypes = {
                Coaching: { icon: 'üéæ', shortDescription: "...", description: "...", category: 'Training' },
                Ausdauer: { icon: 'üèÉ‚Äç‚ôÇÔ∏è', shortDescription: "...", description: "...", category: 'Training' },
                Krafttraining: { icon: 'üèãÔ∏è', shortDescription: "...", description: "...", category: 'Training' },
                Trainingsspiel: { icon: 'üèÜ', shortDescription: "...", description: "...", category: 'Match' },
                Pause: { icon: 'üò¥', shortDescription: "...", description: "...", category: 'Pause' },
                Leer: { icon: '', shortDescription: '', description: '', category: 'Leer' }
            };
            return { defaultPhaseData, defaultTrainingTypes };
        };
        
        const migrateDataModel = (data) => {
            if (!data.version || data.version < DATA_MODEL_VERSION) {
                console.log(`Altes Datenmodell (v${data.version || 'unbekannt'}) erkannt. F√ºhre Migration zu v${DATA_MODEL_VERSION} durch...`);
                
                const { defaultPhaseData, defaultTrainingTypes } = initializeDefaultData();
                const migratedData = {
                    version: DATA_MODEL_VERSION,
                    planId: data.planId || crypto.randomUUID(),
                    syncId: data.syncId || null,
                    lastModified: data.lastModified || new Date().toISOString(),
                    startDateOfPlan: data.startDateOfPlan,
                    trainingProgress: data.trainingProgress || {},
                    trainingTypes: data.trainingTypes || deepClone(defaultTrainingTypes),
                    weeklySchedules: data.weeklySchedules || [],
                    phaseData: data.phaseData || deepClone(defaultPhaseData)
                };
                
                console.log("Migration abgeschlossen.");
                return migratedData;
            }
            return data;
        };

        const saveState = () => {
            try {
                state.lastModified = new Date().toISOString();
                dataChangedSinceLastSync = true;
                const stateToSave = { ...state };
                localStorage.setItem('tennisPlanState', JSON.stringify(stateToSave));
            } catch (e) { console.error("Fehler beim Speichern des Zustands:", e); }
        };

        const initState = () => {
            const { defaultPhaseData, defaultTrainingTypes } = initializeDefaultData();
            state.planId = crypto.randomUUID();
            state.syncId = null;
            state.lastModified = new Date().toISOString();
            state.startDateOfPlan = new Date();
            state.trainingTypes = deepClone(defaultTrainingTypes);
            state.phaseData = deepClone(defaultPhaseData); 
            state.trainingProgress = {};
            state.weeklySchedules = []; 
            saveState();
        };
        
        const loadState = () => {
            try {
                const storedStateJSON = localStorage.getItem('tennisPlanState');
                if (!storedStateJSON) { 
                    initState(); 
                } else {
                    let storedState = JSON.parse(storedStateJSON);
                    storedState = migrateDataModel(storedState);
                    Object.assign(state, storedState);
                    state.startDateOfPlan = parseDate(state.startDateOfPlan);
                }
            } catch (e) {
                console.error("Fehler beim Laden des Zustands:", e);
                initState();
            }
            state.currentWeekIndex = getActualCurrentWeekIndex();
        };

        // --- Logic ---
        const getMondayOfWeek = (weekIndex) => {
            const monday = new Date(state.startDateOfPlan);
            monday.setDate(monday.getDate() + (weekIndex * 7));
            const dayOfWeek = monday.getDay();
            const diffToMonday = monday.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            monday.setDate(diffToMonday);
            monday.setHours(0, 0, 0, 0);
            return monday;
        };
        
        const getActualCurrentWeekIndex = () => {
            if (!state.startDateOfPlan || state.weeklySchedules.length === 0) return -1;
            const today = new Date();
            const diffTime = today.getTime() - state.startDateOfPlan.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const weekIndex = Math.max(0, Math.floor(diffDays / 7));
            return Math.min(weekIndex, state.weeklySchedules.length - 1);
        };

        // --- Rendering ---
        const renderAll = () => {
            renderPhase();
            renderWeek();
            renderChart();
            calculateAndRenderIntensityIndex(); 
            renderStatistics();
            renderWeightChart();
            renderUIState();
        };
        
        const renderRandomTips = () => {
            const container = DOMElements.tipsContainer;
            container.innerHTML = ''; 
            const shuffled = [...allTips].sort(() => 0.5 - Math.random());
            shuffled.slice(0, 3).forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'p-4 rounded-xl box';
                tipElement.innerHTML = `<h4 class="font-bold text-lg mb-2">${tip.icon} ${tip.title}</h4><p class="text-gray-600 text-sm">${tip.text}</p>`;
                container.appendChild(tipElement);
            });
        };

        const renderPhase = () => {
            if (state.currentWeekIndex === -1) {
                DOMElements.phaseGoals.innerHTML = '<p class="text-gray-500">F√ºge eine Woche hinzu.</p>';
                DOMElements.phaseGoalsEditor.value = '';
                DOMElements.phaseSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                return;
            }
            const currentPhase = state.weeklySchedules[state.currentWeekIndex].phase;
            const phaseData = state.phaseData[currentPhase];
            DOMElements.phaseSelector.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.phase == currentPhase));
            DOMElements.phaseGoals.innerHTML = parseMarkdown(phaseData.goals);
            DOMElements.phaseGoalsEditor.value = phaseData.goals;
        };
        
        const renderWeek = () => {
            DOMElements.weeklyPlan.innerHTML = '';
            if (state.currentWeekIndex === -1) {
                DOMElements.currentWeekDisplay.textContent = 'Kein Plan vorhanden';
                return;
            }
            const totalWeeks = state.weeklySchedules.length;
            const monday = getMondayOfWeek(state.currentWeekIndex);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            const dateFormatter = new Intl.DateTimeFormat('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
            
            if (window.innerWidth <= 1023) {
                 DOMElements.currentWeekDisplay.textContent = `Woche ${state.currentWeekIndex + 1} von ${totalWeeks}`;
            } else {
                 DOMElements.currentWeekDisplay.textContent = `Woche ${state.currentWeekIndex + 1} von ${totalWeeks} (${dateFormatter.format(monday)} - ${dateFormatter.format(sunday)})`;
            }

            const schedule = state.weeklySchedules[state.currentWeekIndex].schedule;
            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);
                DOMElements.weeklyPlan.appendChild(createTrainingCard(day, i, schedule[i]));
            }

            if (window.innerWidth <= 1023) {
                const todayCard = DOMElements.weeklyPlan.querySelector('.is-today');
                if (todayCard) {
                    setTimeout(() => todayCard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 150);
                }
            }
        };
        
        const createTrainingCard = (day, dayIndex, activity) => {
            const card = document.createElement('div');
            const today = new Date();
            today.setHours(0,0,0,0);
            const isPast = day < today;
            const isToday = day.getTime() === today.getTime();
            
            const dateKey = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
            const dayProgress = state.trainingProgress[dateKey] || { completed: false };
            const activityType = activity ? activity.type : 'Leer';
            const trainingDetails = state.trainingTypes[activityType] || {};
            const isPause = activityType === 'Pause';
            const isEmptySlot = activityType === 'Leer';
            const dayFormatted = new Intl.DateTimeFormat('de-DE', { day: 'numeric', month: 'numeric' }).format(day);
            
            card.className = 'training-card py-4 px-3 rounded-xl flex flex-col justify-between transition-all duration-200 relative bg-white';
            card.dataset.activity = activityType;
            card.dataset.date = dateKey;
            card.dataset.dayIndex = dayIndex;
            
            if (isToday) card.classList.add('is-today');

            let innerHTML = `<div><p class="font-bold text-sm ${dayProgress.completed ? 'text-[#ecedee]' : 'text-gray-500'}">${DAYS_OF_WEEK[dayIndex]}, ${dayFormatted}</p><p class="font-bold text-lg mt-1 flex items-center gap-2">${isEmptySlot ? '<span class="text-gray-400">Frei</span>' : `${trainingDetails.icon || ''} ${activityType}`}</p><div class="text-xs font-light mt-2 prose">${parseMarkdown(trainingDetails.shortDescription)}</div></div>`;

            if (state.isEditMode) {
                card.classList.add('border-2', 'border-dashed', 'border-gray-400', 'cursor-pointer', 'hover:bg-gray-100');
                if (!isEmptySlot) innerHTML += `<button class="delete-training-btn absolute top-1 right-1 rounded-full w-6 h-6 flex items-center justify-center text-lg z-10"><i class="fa-solid fa-circle-minus"></i></button>`;
            } else {
                if (dayProgress.completed) { card.style.backgroundColor = '#88bab8'; card.style.borderColor = '#63a09d'; }
                else if (isPast && !isPause && !isEmptySlot) { card.style.backgroundColor = '#ead2d5'; card.style.borderColor = '#c9b2b5'; }
                else if (isToday) { card.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2'); }
                if (!isEmptySlot) card.classList.add('cursor-pointer', 'hover:shadow-xl', 'hover:-translate-y-1');
                else card.classList.add('opacity-80');
            }
            card.innerHTML = innerHTML;
            return card;
        };

        const renderUIState = () => {
            DOMElements.editModeToggleBtn.innerHTML = state.isEditMode ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-pencil"></i>';
            DOMElements.editModeToggleBtn.classList.toggle('edit-mode', state.isEditMode);
            DOMElements.addWeekBtn.classList.toggle('hidden', !state.isEditMode);
            DOMElements.deleteWeekBtn.classList.toggle('hidden', !state.isEditMode);
            DOMElements.phaseGoals.classList.toggle('hidden', state.isEditMode);
            DOMElements.phaseGoalsEditor.classList.toggle('hidden', !state.isEditMode);
            DOMElements.prevWeekBtn.disabled = state.currentWeekIndex <= 0;
            DOMElements.nextWeekBtn.disabled = state.currentWeekIndex >= state.weeklySchedules.length - 1;
            DOMElements.versionFooter.textContent = `MatchPlan Pro - v${HTML_VERSION} - Datenmodell v${DATA_MODEL_VERSION}`;
        };

        const renderChart = () => {
            if (state.currentWeekIndex === -1) {
                if (weeklyFocusChart) weeklyFocusChart.destroy();
                weeklyFocusChart = null;
                document.getElementById('weeklyFocusLegend').innerHTML = '';
                return;
            }
            const schedule = state.weeklySchedules[state.currentWeekIndex].schedule;
            const categoryCounts = schedule.reduce((acc, item) => {
                const type = item ? item.type : 'Leer';
                const category = state.trainingTypes[type]?.category || 'Leer';
                if (category !== 'Leer') {
                    acc[category] = (acc[category] || 0) + 1;
                }
                return acc;
            }, {});
            const chartLabels = ['Training', 'Match', 'Regeneration', 'Pause'];
            const chartDataValues = chartLabels.map(label => categoryCounts[label] || 0);
            const backgroundColors = ['rgba(44, 82, 130, 0.8)', '#ed989f', 'rgba(136, 186, 184, 0.8)', '#c1c3c6'];
            const borderColors = ['#2C5282', '#d3848b', '#88bab8', '#a9abb0'];
            const chartData = {
                labels: chartLabels,
                datasets: [{ data: chartDataValues, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }]
            };
            const chartOptions = {
                responsive: true, maintainAspectRatio: false, cutout: '50%',
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        formatter: (value, context) => {
                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            if (total === 0) return '';
                            const percentage = (value / total) * 100;
                            return percentage > 0 ? `${Math.round(percentage)}%` : '';
                        },
                        color: (context) => [2, 3].includes(context.dataIndex) ? '#2c313e' : '#ecedee',
                        font: { weight: 'bold', size: 14 },
                        textShadow: { stroke: 'rgba(0,0,0,0.4)', blur: 4 }
                    }
                }
            };
            const legendContainer = document.getElementById('weeklyFocusLegend');
            legendContainer.innerHTML = '';
            if (weeklyFocusChart) {
                weeklyFocusChart.data = chartData;
                weeklyFocusChart.options = chartOptions;
                weeklyFocusChart.update();
            } else {
                const ctx = document.getElementById('weeklyFocusChart').getContext('2d');
                weeklyFocusChart = new Chart(ctx, { type: 'doughnut', data: chartData, options: chartOptions });
            }
            chartLabels.forEach((label, index) => {
                if (chartDataValues[index] > 0) {
                    const li = document.createElement('div');
                    li.className = 'flex items-center';
                    li.innerHTML = `<span class="w-4 h-4 mr-2 rounded" style="background-color: ${backgroundColors[index]}; border: 1px solid ${borderColors[index]}"></span><span>${label}</span>`;
                    legendContainer.appendChild(li);
                }
            });
        };

        const calculateAndRenderIntensityIndex = () => {
            if (state.currentWeekIndex === -1) {
                DOMElements.intensityIndex.textContent = '‚Äì';
                DOMElements.intensityIndex.style.color = '#969ba0';
                return;
            }
            const schedule = state.weeklySchedules[state.currentWeekIndex].schedule;
            const intensityMultipliers = { 'Match': 3, 'Training': 2, 'Regeneration': 1, 'Pause': 0, 'Leer': 0 };
            let totalPoints = 0;
            schedule.forEach(item => {
                const type = item ? item.type : 'Leer';
                const category = state.trainingTypes[type]?.category || 'Leer';
                totalPoints += intensityMultipliers[category] || 0;
            });
            const maxPoints = 7 * 3;
            const index = Math.round((totalPoints / maxPoints) * 99);
            let color;
            if (index >= 50) color = '#ec777e';
            else if (index >= 40) color = '#eeafb5';
            else if (index >= 30) color = '#55759b';
            else color = '#88bab8';
            DOMElements.intensityIndex.textContent = index;
            DOMElements.intensityIndex.style.color = color;
        };

        const renderStatistics = () => {
            if (state.weeklySchedules.length === 0) {
                DOMElements.statsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Keine Daten vorhanden.</td></tr>`;
                return;
            }
            let totalCompleted = 0, totalMissed = 0, totalOpen = 0;
            let weekCompleted = 0, weekMissed = 0, weekOpen = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const mondayOfCurrentWeek = getMondayOfWeek(state.currentWeekIndex);
            const sundayOfCurrentWeek = new Date(mondayOfCurrentWeek);
            sundayOfCurrentWeek.setDate(mondayOfCurrentWeek.getDate() + 6);
            for (let weekIdx = 0; weekIdx < state.weeklySchedules.length; weekIdx++) {
                const schedule = state.weeklySchedules[weekIdx].schedule;
                const mondayOfWeek = getMondayOfWeek(weekIdx);
                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                    const activity = schedule[dayIdx];
                    if (!activity || activity.type === 'Pause' || activity.type === 'Leer') continue;
                    const day = new Date(mondayOfWeek);
                    day.setDate(mondayOfWeek.getDate() + dayIdx);
                    const dateKey = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
                    const progress = state.trainingProgress[dateKey] || { completed: false };
                    const isPast = day < today;
                    const isInCurrentWeek = day >= mondayOfCurrentWeek && day <= sundayOfCurrentWeek;
                    if (progress.completed) {
                        totalCompleted++;
                        if (isInCurrentWeek) weekCompleted++;
                    } else if (isPast) {
                        totalMissed++;
                        if (isInCurrentWeek) weekMissed++;
                    } else {
                        totalOpen++;
                        if (isInCurrentWeek) weekOpen++;
                    }
                }
            }
            DOMElements.statsTableBody.innerHTML = `<tr><td class="py-2 px-4 font-bold">Gesamt</td><td class="py-2 px-4 text-center font-bold" style="color: #88bab8;">${totalCompleted}</td><td class="py-2 px-4 text-center font-bold" style="color: #ec747c;">${totalMissed}</td><td class="py-2 px-4 text-center font-bold" style="color: #54749b;">${totalOpen}</td></tr><tr><td class="py-2 px-4 font-bold">Aktuelle Woche</td><td class="py-2 px-4 text-center font-bold" style="color: #88bab8;">${weekCompleted}</td><td class="py-2 px-4 text-center font-bold" style="color: #ec747c;">${weekMissed}</td><td class="py-2 px-4 text-center font-bold" style="color: #54749b;">${weekOpen}</td></tr>`;
        };

        const renderWeightChart = () => {
            const weightData = Object.entries(state.trainingProgress).filter(([, data]) => data.weight != null).map(([date, data]) => ({ date: parseDate(date), weight: data.weight })).sort((a, b) => a.date - b.date);
            const labels = weightData.map(d => new Intl.DateTimeFormat('de-DE', { day: '2-digit', month: '2-digit' }).format(d.date));
            const dataPoints = weightData.map(d => d.weight);
            const chartConfig = {
                type: 'line',
                data: {
                    labels,
                    datasets: [{ label: 'Gewicht (kg)', data: dataPoints, borderColor: '#ed989f', backgroundColor: 'rgba(237, 152, 159, 0.1)', fill: true, tension: 0.1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false }, x: {} },
                    plugins: { legend: { display: false }, datalabels: { display: false } }
                }
            };
            const ctx = document.getElementById('weight-curve-chart').getContext('2d');
            if (weightCurveChart) {
                weightCurveChart.data = chartConfig.data;
                weightCurveChart.options = chartConfig.options;
                weightCurveChart.update();
            } else {
                weightCurveChart = new Chart(ctx, chartConfig);
            }
        };

        // --- Modals & Mobile Nav ---
        const showModal = (modal) => {
            modal.classList.remove('invisible', 'opacity-0');
            document.body.style.overflow = 'hidden';
            dataChangedSinceLastSync = false; // Reset flag on modal open
        };

        const hideModal = (modal) => {
            modal.classList.add('invisible', 'opacity-0');
            document.body.style.overflow = '';
            if (dataChangedSinceLastSync && state.syncId) {
                uploadData();
            }
        };

        const openMobileNav = () => {
            DOMElements.mobileNav.classList.add('open');
            DOMElements.mobileNavOverlay.classList.add('open');
        };

        const closeMobileNav = () => {
            DOMElements.mobileNav.classList.remove('open');
            DOMElements.mobileNavOverlay.classList.remove('open');
        };
        
        const showConfirmModal = (text, onConfirm) => {
            DOMElements.confirmModalText.textContent = text;
            showModal(DOMElements.confirmModal);
            const newConfirmBtn = DOMElements.confirmModalConfirmBtn.cloneNode(true);
            DOMElements.confirmModalConfirmBtn.parentNode.replaceChild(newConfirmBtn, DOMElements.confirmModalConfirmBtn);
            DOMElements.confirmModalConfirmBtn = newConfirmBtn;
            DOMElements.confirmModalConfirmBtn.addEventListener('click', () => {
                hideModal(DOMElements.confirmModal);
                onConfirm();
            }, { once: true });
        };

        const showExerciseModal = (activityType, dateKey) => {
            const trainingDetails = state.trainingTypes[activityType] || {};
            const contentHTML = parseMarkdown(trainingDetails.description);
            const icon = trainingDetails.icon || '';
            DOMElements.modalTitle.innerHTML = `${icon} ${activityType}`;
            let fullContent = contentHTML;
            if (activityType !== 'Pause' && activityType !== 'Leer') {
                const progress = state.trainingProgress[dateKey] || {};
                const isFuture = parseDate(dateKey) > new Date();
                const isCompleted = progress.completed;
                const commentHTML = parseMarkdown(progress.comment) || 'Kein Kommentar.';
                fullContent += `<div class="flex items-center mt-6 border-t pt-4"><input type="checkbox" id="modal-checkbox" data-date="${dateKey}" ${isCompleted ? 'checked' : ''} ${isFuture ? 'disabled' : ''} class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="modal-checkbox" class="ml-3 text-lg font-semibold">Erledigt</label></div><div class="mt-4"><h4 class="font-semibold mb-2">Kommentare:</h4><textarea id="modal-comment" data-date="${dateKey}" placeholder="Kommentar hinzuf√ºgen..." class="text-sm w-full p-2 border rounded-md ${isCompleted || isFuture ? 'hidden' : ''}" ${isFuture ? 'disabled' : ''}>${progress.comment || ''}</textarea><div id="modal-comment-display" class="modal-comment-display ${!isCompleted ? 'hidden' : ''}">${commentHTML}</div></div>`;
                const dayIndex = (parseDate(dateKey).getDay() + 6) % 7;
                if (dayIndex === 6) {
                    const weight = progress.weight;
                    const weightDisplay = weight ? `${weight} kg` : 'Kein Gewicht eingetragen.';
                    fullContent += `<div class="mt-4 pt-4 border-t"><h4 class="font-semibold mb-2">Gewicht (kg):</h4><input type="number" step="0.1" id="modal-weight-input" data-date="${dateKey}" placeholder="z.B. 80.5" class="text-sm w-full p-2 border rounded-md ${isCompleted || isFuture ? 'hidden' : ''}" value="${weight || ''}" ${isFuture ? 'disabled' : ''}><div id="modal-weight-display" class="bg-gray-100 border rounded-md p-2 text-sm mt-2 ${!isCompleted ? 'hidden' : ''}">${weightDisplay}</div></div>`;
                }
            }
            DOMElements.modalContent.innerHTML = fullContent;
            showModal(DOMElements.exerciseModal);
        };

        const renderTrainingTypeDatalist = () => {
            DOMElements.trainingTypesList.innerHTML = Object.keys(state.trainingTypes).filter(type => type !== 'Leer' && type !== 'Pause').map(type => `<option value="${type}"></option>`).join('');
        };

        const showAddTrainingModal = (dayIndex, activityType) => {
            const isEditing = !!activityType && activityType !== 'Leer';
            DOMElements.addModalTitle.textContent = isEditing ? 'Training bearbeiten' : 'Training hinzuf√ºgen';
            DOMElements.addTrainingForm.querySelector('select').innerHTML = DAYS_OF_WEEK.map((day, i) => `<option value="${i}" ${i === dayIndex ? 'selected' : ''}>${day}</option>`).join('');
            const details = isEditing ? state.trainingTypes[activityType] : {};
            DOMElements.addTrainingForm.querySelector('input[list="training-types-list"]').value = isEditing ? activityType : '';
            DOMElements.addTrainingForm.querySelector('#add-training-icon-input').value = details.icon || '';
            DOMElements.addTrainingForm.querySelector('#add-training-short-description-input').value = details.shortDescription || '';
            DOMElements.addTrainingForm.querySelector('#add-training-description-input').value = details.description || '';
            DOMElements.addTrainingForm.dataset.dayIndex = dayIndex;
            renderTrainingTypeDatalist();
            showModal(DOMElements.addTrainingModal);
        };

        const renderCategoryEditor = () => {
            const container = DOMElements.categoryEditorContent;
            let editableTypes = Object.entries(state.trainingTypes).filter(([name]) => name !== 'Leer');
            const intensityOrder = { 'Pause': 0, 'Regeneration': 1, 'Training': 2, 'Match': 3 };
            editableTypes.sort((a, b) => {
                const [nameA, detailsA] = a;
                const [nameB, detailsB] = b;
                if (categorySortState.key === 'name') {
                    return categorySortState.order === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
                } else {
                    const intensityA = intensityOrder[detailsA.category];
                    const intensityB = intensityOrder[detailsB.category];
                    return categorySortState.order === 'asc' ? intensityA - intensityB : intensityB - intensityA;
                }
            });
            if (editableTypes.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Keine bearbeitbaren Typen.</p>`;
                return;
            }
            const table = document.createElement('table');
            table.className = 'category-editor-table w-full text-sm';
            table.innerHTML = `<thead><tr><th class="text-left font-semibold p-2 sortable-header" data-sort-key="name">Trainingsart <span class="sort-icon"></span></th><th class="text-left font-semibold p-2 sortable-header" data-sort-key="intensity">Intensit√§t <span class="sort-icon"></span></th></tr></thead><tbody>${editableTypes.map(([name, details]) => `<tr><td class="p-2 font-medium">${name}</td><td class="p-2"><select data-type-name="${name}" class="category-select w-full p-2 border rounded-md bg-gray-50"><option value="Pause" ${details.category === 'Pause' ? 'selected' : ''}>Keine (0)</option><option value="Regeneration" ${details.category === 'Regeneration' ? 'selected' : ''}>Niedrig (1)</option><option value="Training" ${details.category === 'Training' ? 'selected' : ''}>Mittel (2)</option><option value="Match" ${details.category === 'Match' ? 'selected' : ''}>Hoch (3)</option></select></td></tr>`).join('')}</tbody>`;
            container.innerHTML = '';
            container.appendChild(table);
            const activeHeader = container.querySelector(`[data-sort-key="${categorySortState.key}"]`);
            if (activeHeader) activeHeader.querySelector('.sort-icon').textContent = categorySortState.order === 'asc' ? '‚ñ≤' : '‚ñº';
        };
        
        // --- Sync & Backup ---
        const setSyncStatus = (status, message) => {
            const icon = DOMElements.syncStatusIcon;
            icon.classList.remove('is-syncing', 'text-green-500', 'text-red-500');
            switch (status) {
                case 'syncing': icon.className = 'fa-solid fa-cloud-arrow-up is-syncing'; break;
                case 'success': icon.className = 'fa-solid fa-check-circle text-green-500'; break;
                case 'error': icon.className = 'fa-solid fa-exclamation-circle text-red-500'; break;
                default: icon.className = 'fa-solid fa-cloud';
            }
            DOMElements.syncStatusText.textContent = message;
        };

        const uploadData = async () => {
            DOMElements.syncBackupBtn.classList.add('is-processing');
            try {
                if (!state.syncId) {
                    setSyncStatus('syncing', 'Erstelle Speicherort...');
                    const response = await fetch(JSONBLOB_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(state)
                    });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const locationHeader = response.headers.get('Location');
                    if (!locationHeader) throw new Error('Location header not found in response');
                    const newSyncId = locationHeader.split('/').pop();
                    state.syncId = newSyncId;
                    saveState();
                    dataChangedSinceLastSync = false;
                    setSyncStatus('success', 'Online-Speicher erstellt!');
                    updateShareLinkUI();
                } else {
                    setSyncStatus('syncing', 'Lade hoch...');
                    const response = await fetch(`${JSONBLOB_API_URL}/${state.syncId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state)
                    });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    dataChangedSinceLastSync = false;
                    setSyncStatus('success', 'Synchronisiert');
                }
            } catch (error) {
                console.error('Error during upload:', error);
                setSyncStatus('error', 'Upload-Fehler');
            } finally {
                DOMElements.syncBackupBtn.classList.remove('is-processing');
            }
        };

        const fetchData = async (syncId, isUrlSync = false) => {
            DOMElements.syncBackupBtn.classList.add('is-processing');
            setSyncStatus('syncing', 'Pr√ºfe auf Updates...');
            try {
                const response = await fetch(`${JSONBLOB_API_URL}/${syncId}`);
                if (!response.ok) throw new Error('Could not fetch data');
                const remoteData = await response.json();
                
                if (isUrlSync) {
                    console.log("Syncing from URL, overwriting local state.");
                    Object.assign(state, remoteData);
                    state.startDateOfPlan = parseDate(state.startDateOfPlan);
                    localStorage.setItem('tennisPlanState', JSON.stringify(state));
                    dataChangedSinceLastSync = false; 
                    renderAll();
                    setSyncStatus('success', 'Plan geladen');
                } else if (remoteData.planId === state.planId) {
                    if (new Date(remoteData.lastModified) > new Date(state.lastModified)) {
                        console.log("Remote data is newer. Updating local state.");
                        Object.assign(state, remoteData);
                        state.startDateOfPlan = parseDate(state.startDateOfPlan);
                        localStorage.setItem('tennisPlanState', JSON.stringify(state));
                        dataChangedSinceLastSync = false; 
                        renderAll();
                        setSyncStatus('success', 'Aktualisiert');
                    } else {
                        console.log("Local data is up-to-date.");
                        setSyncStatus('success', 'Aktuell');
                    }
                } else {
                    console.warn("Plan ID mismatch on existing plan. Aborting sync.");
                    setSyncStatus('error', 'Falscher Plan');
                }
            } catch (error) {
                console.error("Sync failed:", error);
                setSyncStatus('error', 'Sync-Fehler');
            } finally {
                DOMElements.syncBackupBtn.classList.remove('is-processing');
            }
        };

        const deleteOnlineData = async () => {
            if (!state.syncId) return;
            showConfirmModal("M√∂chten Sie den Online-Plan wirklich l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden. Ihre lokalen Daten bleiben erhalten.", async () => {
                DOMElements.syncBackupBtn.classList.add('is-processing');
                setSyncStatus('syncing', 'L√∂sche Online-Plan...');
                try {
                    const response = await fetch(`${JSONBLOB_API_URL}/${state.syncId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) throw new Error('Could not delete data');
                    state.syncId = null;
                    state.planId = crypto.randomUUID(); // Generate new ID for local plan
                    saveState();
                    updateShareLinkUI();
                    setSyncStatus('success', 'Online-Plan gel√∂scht');
                } catch(error) {
                    console.error("Error deleting online data:", error);
                    setSyncStatus('error', 'L√∂schen fehlgeschlagen');
                } finally {
                    DOMElements.syncBackupBtn.classList.remove('is-processing');
                }
            });
        };

        const syncOnStartup = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const urlSyncId = urlParams.get('syncId');
            
            if (urlSyncId) {
                await fetchData(urlSyncId, true);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (state.syncId) {
                await fetchData(state.syncId);
            }
        };

        const updateShareLinkUI = () => {
            if (state.syncId) {
                const url = `${window.location.origin}${window.location.pathname}?syncId=${state.syncId}`;
                DOMElements.shareLinkInput.value = url;
                DOMElements.shareLinkContainer.classList.remove('hidden');
                DOMElements.deleteOnlineDataBtn.disabled = false;
            } else {
                DOMElements.shareLinkContainer.classList.add('hidden');
                DOMElements.deleteOnlineDataBtn.disabled = true;
            }
        };

        const handleExportClick = () => {
            DOMElements.syncBackupBtn.classList.add('is-processing');
            try {
                const dataToExport = { ...state };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trainingsplan_backup_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } finally {
                setTimeout(() => DOMElements.syncBackupBtn.classList.remove('is-processing'), 500);
            }
        };

        const handleImportChange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            DOMElements.syncBackupBtn.classList.add('is-processing');
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    let importedData = JSON.parse(event.target.result);
                    importedData = migrateDataModel(importedData);
                    const feedbackArea = DOMElements.importFeedbackArea;
                    feedbackArea.innerHTML = `<p>Datei "<strong>${file.name}</strong>" geladen.</p><p class="text-red-600 font-bold my-2">M√∂chten Sie importieren? Alle aktuellen Daten werden √ºberschrieben.</p><button id="confirm-import-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Ja, importieren</button>`;
                    document.getElementById('confirm-import-btn').addEventListener('click', () => {
                        Object.assign(state, importedData);
                        state.startDateOfPlan = parseDate(state.startDateOfPlan);
                        saveState();
                        renderAll();
                        hideModal(DOMElements.syncBackupModal);
                    });
                } catch (error) {
                    DOMElements.importFeedbackArea.innerHTML = `<p class="text-red-600">Fehler: ${error.message}</p>`;
                } finally {
                    e.target.value = null;
                    DOMElements.syncBackupBtn.classList.remove('is-processing');
                }
            };
            reader.onerror = () => {
                DOMElements.syncBackupBtn.classList.remove('is-processing');
            };
            reader.readAsText(file);
        };

        // --- Event Handlers ---
        const handlePhaseClick = (e) => {
            const button = e.target.closest('.phase-btn');
            if (button) {
                const clickedPhase = parseInt(button.dataset.phase, 10);
                const actualCurrentWeekIndex = getActualCurrentWeekIndex();
                if (actualCurrentWeekIndex === -1) return;
                const phaseOfActualWeek = state.weeklySchedules[actualCurrentWeekIndex].phase;
                if (clickedPhase === phaseOfActualWeek) state.currentWeekIndex = actualCurrentWeekIndex;
                else {
                    const firstWeekOfPhase = state.weeklySchedules.findIndex(w => w.phase === clickedPhase);
                    if (firstWeekOfPhase !== -1) state.currentWeekIndex = firstWeekOfPhase;
                }
                renderAll();
            }
        };

        const handleWeeklyPlanClick = (e) => {
            const card = e.target.closest('.training-card');
            if (!card) return;
            const { activity, date, dayIndex } = card.dataset;
            const dayIndexNum = parseInt(dayIndex, 10);
            if (state.isEditMode) {
                if (e.target.closest('.delete-training-btn')) {
                    e.stopPropagation();
                    state.weeklySchedules[state.currentWeekIndex].schedule[dayIndexNum].type = 'Leer';
                    saveState();
                    renderAll();
                } else {
                    showAddTrainingModal(dayIndexNum, activity);
                }
            } else if (activity !== 'Leer') {
                showExerciseModal(activity, date);
            }
        };
        
        const handleModalInteraction = (e) => {
            const dateKey = e.target.dataset.date;
            if (!dateKey) return;
            state.trainingProgress[dateKey] = state.trainingProgress[dateKey] || {};
            if (e.target.id === 'modal-checkbox') {
                const isChecked = e.target.checked;
                state.trainingProgress[dateKey].completed = isChecked;
                const modal = e.target.closest('.modal');
                const commentInput = modal.querySelector('#modal-comment');
                const commentDisplay = modal.querySelector('#modal-comment-display');
                const weightInput = modal.querySelector('#modal-weight-input');
                const weightDisplay = modal.querySelector('#modal-weight-display');
                if (isChecked) {
                    commentDisplay.innerHTML = parseMarkdown(commentInput.value) || 'Kein Kommentar.';
                    if(weightInput) weightDisplay.textContent = weightInput.value ? `${weightInput.value} kg` : 'Kein Gewicht eingetragen.';
                }
                commentInput.classList.toggle('hidden', isChecked);
                commentDisplay.classList.toggle('hidden', !isChecked);
                if (weightInput) {
                    weightInput.classList.toggle('hidden', isChecked);
                    if (weightDisplay) weightDisplay.classList.toggle('hidden', !isChecked);
                }
                saveState();
                renderWeek();
                renderStatistics();
            } else if (e.target.id === 'modal-comment') {
                state.trainingProgress[dateKey].comment = e.target.value;
                saveState();
            } else if (e.target.id === 'modal-weight-input') {
                const weightValue = e.target.value;
                state.trainingProgress[dateKey].weight = (weightValue === '' || isNaN(parseFloat(weightValue))) ? null : parseFloat(weightValue);
                saveState();
                renderWeightChart();
            }
        };

        const handleAddFormSubmit = (e) => {
            e.preventDefault();
            const dayIndex = parseInt(DOMElements.addTrainingForm.dataset.dayIndex, 10);
            const newType = DOMElements.addTrainingForm.querySelector('input[list="training-types-list"]').value.trim();
            if (!newType) return;
            let category = state.trainingTypes[newType]?.category || 'Training';
            state.trainingTypes[newType] = {
                icon: DOMElements.addTrainingForm.querySelector('#add-training-icon-input').value.trim(),
                shortDescription: DOMElements.addTrainingForm.querySelector('#add-training-short-description-input').value.trim(),
                description: DOMElements.addTrainingForm.querySelector('#add-training-description-input').value.trim(),
                category: category
            };
            state.weeklySchedules[state.currentWeekIndex].schedule[dayIndex] = { type: newType };
            saveState();
            hideModal(DOMElements.addTrainingModal);
            renderAll();
        };

        const handleJumpToCurrentWeek = () => {
            state.currentWeekIndex = getActualCurrentWeekIndex();
            renderAll();
        };

        const handleAddWeek = () => {
            const newWeek = {
                phase: state.weeklySchedules.length > 0 ? state.weeklySchedules[state.weeklySchedules.length-1].phase : 1,
                schedule: Array(7).fill({type: 'Leer'})
            };
            if (state.weeklySchedules.length === 0) state.startDateOfPlan = new Date();
            state.weeklySchedules.push(newWeek);
            state.currentWeekIndex = state.weeklySchedules.length - 1;
            saveState();
            renderAll();
        };

        const handleDeleteWeek = () => {
            if (state.weeklySchedules.length === 0) return;
            showConfirmModal("M√∂chten Sie diese Woche wirklich l√∂schen? Alle zugeh√∂rigen Fortschrittsdaten f√ºr diese 7 Tage gehen verloren.", () => {
                const mondayOfWeek = getMondayOfWeek(state.currentWeekIndex);
                for (let i = 0; i < 7; i++) {
                    const day = new Date(mondayOfWeek);
                    day.setDate(mondayOfWeek.getDate() + i);
                    const dateKey = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
                    delete state.trainingProgress[dateKey];
                }
                state.weeklySchedules.splice(state.currentWeekIndex, 1);
                if (state.currentWeekIndex >= state.weeklySchedules.length) {
                    state.currentWeekIndex = state.weeklySchedules.length - 1;
                }
                saveState();
                renderAll();
            });
        };

        const handleGoalsEdit = (e) => {
            const currentPhase = state.weeklySchedules[state.currentWeekIndex].phase;
            state.phaseData[currentPhase].goals = e.target.value;
            saveState();
        };
        
        // --- Init ---
        const init = async () => {
            loadState();
            await syncOnStartup();
            
            const openSyncModal = () => {
                updateShareLinkUI();
                DOMElements.importFeedbackArea.innerHTML = '';
                showModal(DOMElements.syncBackupModal);
            };
            DOMElements.syncBackupBtn.addEventListener('click', openSyncModal);
            DOMElements.mobileSyncBackupBtn.addEventListener('click', () => { closeMobileNav(); openSyncModal(); });

            document.querySelectorAll('.modal-close-button').forEach(btn => btn.addEventListener('click', (e) => hideModal(e.target.closest('.modal'))));
            document.querySelectorAll('.modal-cancel-button').forEach(btn => btn.addEventListener('click', (e) => hideModal(e.target.closest('.modal'))));
            document.querySelectorAll('.modal').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(modal); }));

            DOMElements.createShareLinkBtn.addEventListener('click', () => { if (!state.syncId) uploadData(); else updateShareLinkUI(); });
            DOMElements.copyLinkBtn.addEventListener('click', () => { DOMElements.shareLinkInput.select(); document.execCommand('copy'); });
            DOMElements.manualSyncBtn.addEventListener('click', () => { if (state.syncId) uploadData(); else alert("Bitte erstellen Sie zuerst einen Freigabe-Link."); });
            DOMElements.deleteOnlineDataBtn.addEventListener('click', deleteOnlineData);
            DOMElements.exportDataBtn.addEventListener('click', handleExportClick);
            DOMElements.importFileInput.addEventListener('change', handleImportChange);

            DOMElements.phaseSelector.addEventListener('click', handlePhaseClick);
            DOMElements.prevWeekBtn.addEventListener('click', () => { if (state.currentWeekIndex > 0) { state.currentWeekIndex--; renderAll(); } });
            DOMElements.nextWeekBtn.addEventListener('click', () => { if (state.currentWeekIndex < state.weeklySchedules.length - 1) { state.currentWeekIndex++; renderAll(); } });
            DOMElements.editModeToggleBtn.addEventListener('click', () => { state.isEditMode = !state.isEditMode; renderAll(); });
            DOMElements.weeklyPlan.addEventListener('click', handleWeeklyPlanClick);
            DOMElements.currentWeekContainer.addEventListener('click', handleJumpToCurrentWeek);
            DOMElements.addTrainingForm.addEventListener('submit', handleAddFormSubmit);
            DOMElements.modalContent.addEventListener('input', handleModalInteraction);
            DOMElements.addWeekBtn.addEventListener('click', handleAddWeek);
            DOMElements.deleteWeekBtn.addEventListener('click', handleDeleteWeek);
            DOMElements.editCategoriesBtn.addEventListener('click', () => { renderCategoryEditor(); showModal(DOMElements.editCategoriesModal); });
            DOMElements.categoryEditorContent.addEventListener('click', (e) => {
                const header = e.target.closest('.sortable-header');
                if (header) {
                    const sortKey = header.dataset.sortKey;
                    if (categorySortState.key === sortKey) {
                        categorySortState.order = categorySortState.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        categorySortState.key = sortKey;
                        categorySortState.order = 'asc';
                    }
                    renderCategoryEditor();
                }
            });
            DOMElements.categoryEditorContent.addEventListener('change', (e) => {
                if (e.target.classList.contains('category-select')) {
                    const typeName = e.target.dataset.typeName;
                    const newCategory = e.target.value;
                    if (state.trainingTypes[typeName]) {
                        state.trainingTypes[typeName].category = newCategory;
                        saveState();
                    }
                }
            });
            DOMElements.phaseGoalsEditor.addEventListener('input', handleGoalsEdit);
            DOMElements.burgerMenuBtn.addEventListener('click', openMobileNav);
            DOMElements.mobileNavOverlay.addEventListener('click', closeMobileNav);

            renderAll();
            renderRandomTips(); 
        };

        init();
    });
    </script>
</body>
</html>
